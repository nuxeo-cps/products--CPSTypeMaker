<tal:block define="
  type_id request/type_id|options/type_id;
  definitions here/cpstypes_get_definitions;
  validate python: request.has_key('cpsdirectory_entry_edit_form');
  edit_request python: validate and request or nothing;
  delete_allowed python:0;
  typeob here/portal_types/?type_id;
  title typeob/title|type_id;
  expanded_title title;
  base_layouts definitions/base_layouts;
  layoutid python:typeob.layouts[len(base_layouts)];
  layoutob here/portal_layouts/?layoutid;
  debug nothing;
  ">
<metal:block use-macro="here/main_template/macros/master">
  <metal:block fill-slot="css_slot">
    <tal:block define="dt_title python:here.Localizer.default('Document Types');
                       dummy python:request.set('breadcrumb_set',
                        [{
                          'id': 'types',
                          'url': here.portal_url()+'/cpstypes_list',
                          'longtitle': dt_title,
                          'title': dt_title,
                         },
                         {
                          'id': 'types',
                          'url': here.portal_url()+'/cpstypes_edit?type_id='+type_id,
                          'longtitle': title,
                          'title': title,
                        }]);" />
    <tal:block condition="delete_allowed">
      <tal:block define="global actions python:
actions['object'].append({'id':'delete_entry',
  'url':base_url+'cpsdirectory_entry_delete?type_id='+type_id,
  'onclick': 'return window.confirm(\''+ here.Localizer.default('description_confirm_delete').encode('ISO-8859-15', 'ignore') +'\')' ,
  'name': 'cpsdir_label_delete_entry',
  'category': 'object'})" />
    </tal:block>

    <link rel="Stylesheet" type="text/css" href=""
      tal:attributes="href string:${base_url}document.css">
  </metal:block>

  <metal:block fill-slot="header">
    <h1><span i18n:translate="" tal:content="title" /></h1>
  </metal:block>

  <metal:block fill-slot="main">
    <form method="post" action="cpstypes_modify" enctype="multipart/form-data">
      <input type="hidden" name="type_id" tal:attributes="value type_id">
      <table>
        <tr>
          <th align='right' i18n:translate="">cpstypes_type_title</th>
          <td><input type="text" size=50 name="title" tal:attributes="value typeob/title"></td>
        </tr>
        <tr>
          <th align='right' i18n:translate="">cpstypes_type_description</th>
          <td><textarea cols=48 name="description" tal:content="typeob/description" /></td>
        </tr>
        <tr>
          <th align='right' i18n:translate="">cpstypes_type_icon</th>
          <td>
            <img tal:attributes="src string:${here/portal_url}/${typeob/content_icon}" />
            <input type="file" name="new_icon" />
          </td>
        </tr>
        <tr>
          <th align='right' i18n:translate="">cpstypes_type_is_flexible</th>
          <td tal:define="flexible_layout python:definitions['flexible_layout']">
            <input type="checkbox" name="is_flexible" 
              tal:attributes="checked python:flexible_layout in typeob.layouts" />
          </td>
        </tr>
      </table>
      <h3 i18n:translate="">cpstypes_widgets</h3>
      <table>
        <tr align="left">
          <th></th>
          <th i18n:translate="">cpstypes_widget_id</th>
          <th i18n:translate="">cpstypes_widget_title</th>
          <th i18n:translate="">cpstypes_widget_type</th>
          <th i18n:translate="">cpstypes_widget_size</th>
          <th i18n:translate="">cpstypes_widget_required</th>
        </tr>
        <tal:block define="layoutdef layoutob/getLayoutDefinition" repeat="row layoutdef/rows">
          <tr tal:condition="debug">
            <td tal:content="python:typeob.layouts" />
          </tr>
          <tr tal:repeat="entry row">
            <tal:block define="widgetname entry/widget_id;
                               widget python:layoutob[widgetname];
                               widgetid widget/getId;
                               ">
              <td>
                <input type="hidden" name="widgetinfo.id:records" tal:attributes="value widgetid"/>
                <input type="hidden" name="widgetinfo.name:records" tal:attributes="value widgetname"/>
                <input type="checkbox" name="widgetinfo.is_selected:records" />
              </td>
              <td tal:content="python:widget.fields[0]" />
              <td><input type="text" size=20 name="widgetinfo.title:records" tal:attributes="value widget/label" /></td>
              <td tal:content="widget/meta_type" />
              <td>
                <input type="text" size=10 name="widgetinfo.size:records"
                  tal:attributes="value widget/size_max" 
                  tal:condition="python:hasattr(widget, 'size_max')" />
                <input type="hidden" name="widgetinfo.size:records"
                  tal:attributes="value python:0" 
                  tal:condition="python:not hasattr(widget, 'size_max')" />
              </td>
              <td><input type="checkbox" name="widgetinfo.required:records"
                tal:attributes="checked widget/is_required" /></td>
            </tal:block>
          </tr>
        </tal:block>
      </table>
      <input type="submit" name="action_delete" value="button_delete" i18n:attributes="value" />
      <input type="submit" name="action_save" value="button_save" i18n:attributes="value" />
    </form>
    <form method="post" action="cpstypes_add_widget">
      <input type="hidden" name="layout_id" tal:attributes="value layoutid">
      <table>
        <tr>
          <th i18n:translate="">cpstypes_add_new_widget</th>
          <td>
            <select name="new_field" tal:define="schema here/cpstypes_get_schema">
              <tal:block tal:repeat="field schema/objectValues">
              <option tal:attributes="value field/getFieldId"
                      tal:content="field/getFieldId"
                      tal:condition="python:not hasattr(layoutob, 'w__' + field.getFieldId())" />
              </tal:block>
            </select>
          </td>
          <td>
            <input type="submit" name="add_field" value="button_add" i18n:attributes="value" />
          <td>
        </tr>
      </table>
    </form>
  </metal:block>
</metal:block>
</tal:block>
